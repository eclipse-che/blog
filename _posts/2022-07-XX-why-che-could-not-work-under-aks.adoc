---
title: Why Eclipse Che version before 7.50 could not work under AKS
layout: post
author: Serguei Gorokhov and Piotr Karatkevich
description: >-
  In this blog post, we'll tell the story how we installed Eclipse Che on Microsoft Azure, what problems we met and how solved them.
categories: []
keywords: ['AKS', 'Azure Kubernetes Service', 'AAD', 'Azure Active Directory']
slug: /@piotr.karatkevich/why-che-could-not-work-under-aks
---

We installed Eclipse Che on AKS cluster integrated with Azure AD according to link:https://www.eclipse.org/che/docs/che-7/installation-guide/installing-che-on-microsoft-azure/[instruction]. To our surprise it did not work. So, we decided to spend some time and made it workable.

NOTE: Details how to integrate AKS with Azure AD can be found link:https://docs.microsoft.com/en-us/azure/aks/managed-aad[here].

== Problem 1: AKS does not support id_token
Eclipse Che sends `id_token` for installations made for Kubernetes. But in our case AKS does not accept `id_token` (it only accepts `access_token`) due to Azure AD integration enabled.

image::/assets/img/why-che-could-not-work-under-aks/aks-does-not-support-id_token.png[AKS does not support id_token]

. Eclipse Che is configured to use Azure AD as Identity Provider.
. Azure AD provides an `access_token`, `id_token`, and a `refresh_token`.
. Eclipse Che sends the `id_token` to AKS API Server.
. AKS API Server requires `access_token` and returns auth error.

=== How we solved first problem
Obviously we need a way to ask Eclipse Che to send `access_token` instead of `id_token`. We opened the link:https://github.com/eclipse/che/issues/21450[che-operator enhancement] and proposed the link:https://github.com/eclipse-che/che-operator/pull/1400[solution].

As result new configuration field `identityToken` has been introduced into Eclipse Che starting version 7.50+. Now user can easily configure what token to be passed to upstreams in CheCluster custom resource:
[source,yaml]
----
spec:
  networking:
    auth:
      identityToken: access_token
----
There are two types of tokens supported: `id_token` and `access_token`. Default value is `id_token`.

NOTE: The field `identityToken` is specific to Eclipse Che installations made for Kubernetes only and ignored for OpenShift.

== Problem 2: No way to configure authorization scopes for 'Azure Kubernetes Service AAD Server' application.
Eclipse Che sends default authorization scopes `openid email profile` for token acquiring. But in case of **Azure Kubernetes Service** we need to send predefined `6dae42f8-4368-4678-94ff-3960e28e3630/.default` authorization scope to get a proper audience.

image::/assets/img/why-che-could-not-work-under-aks/incorrect-audience.png[Incorrect audience]

1. Eclipse Che uses default authorization scopes `openid email profile` to get tokens.
2. Azure AD provides an `access_token`, `id_token`, and a `refresh_token` based on requested authorization scopes.
3. Eclipse Che sends the `access_token` to AKS API Server.
4. Token validation fails due to incorrect audience.

=== How we solved second problem
New configuration field `oAuthScope` has been introduced into Eclipse Che starting version 7.50+ in scope of already opened link:https://github.com/eclipse/che/issues/21450[che-operator enhancement] and provided link:https://github.com/eclipse-che/che-operator/pull/1400[solution]. Now user can easily configure authorization scopes in CheCluster custom resource:
[source,yaml]
----
spec:
  networking:
    auth:
      oAuthScope: openid email profile 6dae42f8-4368-4678-94ff-3960e28e3630/.default
----
NOTE: The field `identityToken` is specific to Eclipse Che installations made for Kubernetes only and ignored for OpenShift.

== Problem 3: Che server requires mandatory 'email' claim
As was mentioned early our AKS cluster integrated with Azure AD. It means we need to use 'Azure Kubernetes Service AAD Server' enterprise application defined and managed by Azure itself.

image::/assets/img/why-che-could-not-work-under-aks/aks-aad-server-app.png[Azure Kubernetes Service AAD Server]

Due to this fact we have no control of `access_token` structure. We should use it as is. Provided `access_token` does not have `email` claim.

At the same time Che server (one of the important Eclipse Che link:https://www.eclipse.org/che/docs/stable/administration-guide/server-components/[components]) requires `email` claim. Unfortunately, there is no way to configure Che server to use other attribute for 'email' claim. 

=== How we solved third problem
Obviously we need a way to ask Che server to use other attribute instead of `email`. We opened the link:https://github.com/eclipse/che/issues/21515[che-server enhancement]. Right now we are working to poropose the solution.
