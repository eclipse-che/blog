---
title: Why Eclipse Che version before 7.50 could not work under AKS
layout: post
author: Serguei Gorokhov and Piotr Karatkevich
description: >-
  In this blog post, we'll tell the story how we installed Eclipse Che on Microsoft Azure, what problems we met and how solved them.
categories: []
keywords: ['AKS', 'Azure Kubernetes Service', 'AAD', 'Azure Active Directory']
slug: /@piotr.karatkevich/why-che-could-not-work-under-aks
---

We installed Eclipse Che on AKS cluster integrated with Azure AD according to link:https://www.eclipse.org/che/docs/che-7/installation-guide/installing-che-on-microsoft-azure/[instruction]. To our surprise it did not work. So, we decided to spend some time and made it workable.

NOTE: Taking into account that Eclipse Che calls Kubernetes API server using user's identity tokens generated by Identity Provider, AKS need to be integrated with Azure AD, otherwise token validation will be failed by AKS. Details how to integrate AKS with Azure AD can be found link:https://docs.microsoft.com/en-us/azure/aks/managed-aad[here].

== Problem 1: AKS does not accept id_token
Eclipse Che sends `id_token` for installations made for Kubernetes. But in our case AKS does not accept `id_token` (it only accepts `access_token`) due to Azure AD integration enabled.

image::/assets/img/why-che-could-not-work-under-aks/aks-does-not-support-id_token.png[AKS does not support id_token]

. Eclipse Che is configured to use Azure AD as Identity Provider.
. Azure AD provides an `access_token`, `id_token`, and a `refresh_token`.
. Eclipse Che sends the `id_token` to AKS API Server.
. AKS API Server requires `access_token` and returns auth error.

=== How we solved first problem
Obviously we need a way to ask Eclipse Che to send `access_token` instead of `id_token`. We opened the link:https://github.com/eclipse/che/issues/21450[che-operator enhancement] and proposed the link:https://github.com/eclipse-che/che-operator/pull/1400[solution].

As result new configuration field `identityToken` has been introduced into Eclipse Che starting version 7.50+. Now user can easily configure what token to be passed to upstreams in CheCluster custom resource:
[source,yaml]
----
spec:
  networking:
    auth:
      identityToken: access_token
----
There are two types of tokens supported: `id_token` and `access_token`. Default value is `id_token`.

NOTE: The field `identityToken` is specific to Eclipse Che installations made for Kubernetes only and ignored for OpenShift.

== Problem 2: No way to obtain proper access token accepted by AKS
This is a continuation of Problem 1 in a way that after we taught Che to leverage `access_token` instead of `id_token` to access AKS, we need to make sure this `access_token` is accepted by AKS.

When AKS integration with Azure AD is enabled, AKS expects OpenID Connect (OIDC) tokens issued to the certain application, pre-registered in Azure AD: 'Azure Kubernetes Service AAD Server' (see screenshot from the portal).

image::/assets/img/why-che-could-not-work-under-aks/aks-aad-server-app.png[Azure Kubernetes Service AAD Server]

If we leave default settings of oauth-proxy, leveraged in che gateway, it uses standard set of OIDC scopes and for them Azure AD returns an `access_token` that can be used against Microsoft Graph, not AKS.

In order to obtain a token suitable for AKS, additional scope should be configured for oauth-proxy, representing Azure Kubernetes Service AAD Server:
[source,yaml]
----
6dae42f8-4368-4678-94ff-3960e28e3630/.default
----
where GUID is a AppID for AKS registered in Azure AD.

=== How we solved second problem
New configuration field `oAuthScope` has been introduced into Eclipse Che starting version 7.50+ in scope of already opened link:https://github.com/eclipse/che/issues/21450[che-operator enhancement] and provided link:https://github.com/eclipse-che/che-operator/pull/1400[solution]. Now user can easily configure authorization scopes in CheCluster custom resource:
[source,yaml]
----
spec:
  networking:
    auth:
      oAuthScope: openid email profile 6dae42f8-4368-4678-94ff-3960e28e3630/.default
----
NOTE: The field `identityToken` is specific to Eclipse Che installations made for Kubernetes only and ignored for OpenShift.

== Problem 3: Che server requires mandatory 'email' claim which is absent in AKS access_token
Besides passing OIDC token to AKS for authorization purposes, Che server (one of the important Eclipse Che link:https://www.eclipse.org/che/docs/stable/administration-guide/server-components/[components]) also uses it for creating a 'user' record in internal database. There are two pieces of information (claims) about current user that Che server expects to extract from the token: name and email. Che allows configuring of user name's claim via CheCluster CDR in AKS (`CHE_OIDC_USERNAME__CLAIM` according to link:https://www.eclipse.org/che/docs/next/administration-guide/advanced-configuration-options-for-the-che-server-component/#_che_oidc_username_claim[documentation]), but email's claim's name is hardcoded to "email" and cannot be changed. This hardcode becomes a problem for AKS setup since access_token returned by AAD for AKS does not contain email claim (see current structure below), and customization is not possible here since AKS application registration in AAD is maintained by Microsoft.
[source,json]
----
{
  "typ": "JWT",
  "alg": "RS256",
  "x5t": "2ZQpJ3UpbjAYXYGaXEJl8lV0TOI",
  "kid": "2ZQpJ3UpbjAYXYGaXEJl8lV0TOI"
}.{
  "aud": "6dae42f8-4368-4678-94ff-3960e28e3630",
  "iss": "https://sts.windows.net/f974903a-f693-4ca2-aa63-45e5bd2d1318/",
  "iat": 1656412511,
  "nbf": 1656412511,
  "exp": 1656417802,
  "acr": "1",
  "aio": "AUQAu/8TAABB1o0F/h6L8SJWLibrQqPKrVF7qpdIFiQ0qeIj/wNUfcLkM87v+wgvQ+I8uj0WC2Y6WEoHlBcsJdt0m+kJ4dFeNw==",
  "amr": [
    "pwd"
  ],
  "appid": "1c0b88a0-8ec2-4cca-a2b0-4f468110ef86",
  "appidacr": "1",
  "family_name": "Kluklu",
  "given_name": "Tratata",
  "groups": [
    "73fdccdf-e10d-45f9-b7f6-31848842999f",
    "5988d043-3af9-4e81-b041-90b3456f9f4e",
    "bddcb049-0337-4dec-bbaf-7600b8c12623"
  ],
  "ipaddr": "10.123.51.3",
  "name": "Tratata Kluklu",
  "oid": "2cf0521c-c76d-4e7c-b41f-863674057db3",
  "onprem_sid": "S-2-4-31-6364504-298352422-13854118-387761",
  "puid": "3213CDFA3CAF2IA5",
  "rh": "0.AQkA1NIbtJ39JkuKaqbJ82fCHscCrm1oG3hTlP47YOQHDjAJAHg.",
  "scp": "user.read",
  "sub": "qweBLvHX49QA5WlXpJzq_erXQ2NldnSqpgY93oALLDY",
  "tid": "a385e78a-aedc-4033-82ba-e6ef88120591",
  "unique_name": "Tratata.Kluklu@gmail.com",
  "upn": "Tratata.Kluklu@gmail.com",
  "uti": "lfZmPsgcWmS3dG78GpMjRA",
  "ver": "1.0",
  "wids": [
    "c79abafb-610b-4a34-82e2-ef7a293db6ca"
  ]
}.[Signature]
----


=== How we solved third problem
Obviously we need a way to ask Che server to use other attribute instead of `email`. We opened the link:https://github.com/eclipse/che/issues/21515[che-server enhancement]. Right now we are working to poropose the solution.
