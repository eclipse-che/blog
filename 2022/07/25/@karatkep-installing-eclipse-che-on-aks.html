<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Begin Jekyll SEO tag v2.8.0 -->
    <title>
      Installing Eclipse Che on the Azure Kubernetes Service (AKS) | Eclipse Che
      Blog
    </title>
    <meta name="generator" content="Jekyll v4.2.2" />
    <meta
      property="og:title"
      content="Installing Eclipse Che on the Azure Kubernetes Service (AKS)"
    />
    <meta name="author" content="Serguei Gorokhov and Piotr Karatkevich" />
    <meta property="og:locale" content="en_US" />
    <meta
      name="description"
      content="In this blog post, we’ll tell the story how we installed Eclipse Che on Microsoft Azure, what challenges we met and how solved them."
    />
    <meta
      property="og:description"
      content="In this blog post, we’ll tell the story how we installed Eclipse Che on Microsoft Azure, what challenges we met and how solved them."
    />
    <link
      rel="canonical"
      href="https://che.eclipseprojects.io/2022/07/25/@karatkep-installing-eclipse-che-on-aks.html"
    />
    <meta
      property="og:url"
      content="https://che.eclipseprojects.io/2022/07/25/@karatkep-installing-eclipse-che-on-aks.html"
    />
    <meta property="og:site_name" content="Eclipse Che Blog" />
    <meta property="og:type" content="article" />
    <meta
      property="article:published_time"
      content="2022-07-25T00:00:00+00:00"
    />
    <meta name="twitter:card" content="summary" />
    <meta
      property="twitter:title"
      content="Installing Eclipse Che on the Azure Kubernetes Service (AKS)"
    />
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "author": {
          "@type": "Person",
          "name": "Serguei Gorokhov and Piotr Karatkevich"
        },
        "dateModified": "2022-07-25T00:00:00+00:00",
        "datePublished": "2022-07-25T00:00:00+00:00",
        "description": "In this blog post, we’ll tell the story how we installed Eclipse Che on Microsoft Azure, what challenges we met and how solved them.",
        "headline": "Installing Eclipse Che on the Azure Kubernetes Service (AKS)",
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": "https://che.eclipseprojects.io/2022/07/25/@karatkep-installing-eclipse-che-on-aks.html"
        },
        "url": "https://che.eclipseprojects.io/2022/07/25/@karatkep-installing-eclipse-che-on-aks.html"
      }
    </script>
    <!-- End Jekyll SEO tag -->
    <link rel="stylesheet" href="/assets/main.css" />
    <link
      type="application/atom+xml"
      rel="alternate"
      href="https://che.eclipseprojects.io/feed.xml"
      title="Eclipse Che Blog"
    />
    <script>
      if (
        !(
          window.doNotTrack === "1" ||
          navigator.doNotTrack === "1" ||
          navigator.doNotTrack === "yes" ||
          navigator.msDoNotTrack === "1"
        )
      ) {
        (function (i, s, o, g, r, a, m) {
          i["GoogleAnalyticsObject"] = r;
          (i[r] =
            i[r] ||
            function () {
              (i[r].q = i[r].q || []).push(arguments);
            }),
            (i[r].l = 1 * new Date());
          (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
          a.async = 1;
          a.src = g;
          m.parentNode.insertBefore(a, m);
        })(
          window,
          document,
          "script",
          "https://www.google-analytics.com/analytics.js",
          "ga"
        );

        ga("create", "UA-215676970-1", "auto");
        ga("send", "pageview");
      }
    </script>
  </head>
  <body>
    <header class="site-header" role="banner">
      <div class="wrapper">
        <a class="site-title" rel="author" href="/">Eclipse Che Blog</a>
        <nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger" />
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewBox="0 0 18 15" width="18px" height="15px">
                <path
                  d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"
                />
              </svg>
            </span>
          </label>

          <div class="trigger"></div>
        </nav>
      </div>
    </header>
    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article
          class="post h-entry"
          itemscope
          itemtype="http://schema.org/BlogPosting"
        >
          <header class="post-header">
            <h1 class="post-title p-name" itemprop="name headline">
              Installing Eclipse Che on the Azure Kubernetes Service (AKS)
            </h1>
            <p class="post-meta">
              <time
                class="dt-published"
                datetime="2022-07-25T00:00:00+00:00"
                itemprop="datePublished"
                >Jul 25, 2022 </time
              >•
              <span
                itemprop="author"
                itemscope
                itemtype="http://schema.org/Person"
                ><span class="p-author h-card" itemprop="name"
                  >Serguei Gorokhov and Piotr Karatkevich</span
                ></span
              >
            </p>
          </header>

          <div class="post-content e-content" itemprop="articleBody">
            <div class="paragraph">
              <p>
                We installed Eclipse&#160;Che on AKS (Azure Kubernetes Service)
                cluster integrated with AAD (Azure Active Directory) according
                to
                <a
                  href="https://www.eclipse.org/che/docs/che-7/installation-guide/installing-che-on-microsoft-azure/"
                  >these old (7.41) instructions</a
                >
                (there is no recent version of AKS installation documentation).
                And to our surprise it did not work. Here at Epam Systems we
                love complex challenges, so we decided not to stop and deep
                dived into Eclipse&#160;Che world to improve interaction with
                Microsoft Azure.
              </p>
            </div>
            <div class="admonitionblock note">
              <table>
                <tr>
                  <td class="icon">
                    <div class="title">Note</div>
                  </td>
                  <td class="content">
                    Taking into account that Eclipse&#160;Che calls Kubernetes
                    API server using user&#8217;s identity tokens generated by
                    Identity Provider, AKS needs to be integrated with AAD,
                    otherwise AKS will reject the token. Details how to
                    integrate AKS with AAD can be found
                    <a
                      href="https://docs.microsoft.com/en-us/azure/aks/managed-aad"
                      >here</a
                    >.
                  </td>
                </tr>
              </table>
            </div>
            <div class="paragraph">
              <p>
                Architecture diagram below can be used to get a context about
                our case. Please note that some of the components are omitted
                for the sake of simplicity. But it should be enough to get up to
                speed and dive into Eclipse&#160;Che world together with us.
              </p>
            </div>
            <div class="imageblock">
              <div class="content">
                <img
                  src="/assets/img/installing-eclipse-che-on-aks/che-in-aks.png"
                  alt="Eclipse Che components deployed on AKS"
                />
              </div>
              <div class="title">
                Figure 1. Eclipse Che components deployed on AKS
              </div>
            </div>
            <div class="sect1">
              <h2 id="_challenge-1-aks-does-not-accept-id_token">
                Challenge 1: AKS does not accept <code>id_token</code>
              </h2>
              <div class="sectionbody">
                <div class="paragraph">
                  <p>
                    <a href="https://oauth2-proxy.github.io/oauth2-proxy/"
                      >OAuth2 Proxy</a
                    >
                    is configured to send an <code>id_token</code> to Traefik
                    for installations made for Kubernetes.
                    <a href="https://traefik.io/traefik/">Traefik</a>, in turn,
                    sends the <code>id_token</code> to all upstream services,
                    including components such as Che server and User Dashboard.
                    Che server and User Dashboard call AKS API Server using the
                    provided <code>id_token</code>. But when AKS is configured
                    to use AAD, its API Server does not accept
                    <code>id_token</code> (it only accepts
                    <code>access_token</code>).
                  </p>
                </div>
                <div class="sect2">
                  <h3 id="_how-did-we-solve-the-first-challenge">
                    How did we solve the first challenge
                  </h3>
                  <div class="paragraph">
                    <p>
                      We need a way to ask OAuth2 Proxy to send an
                      <code>access_token</code> instead of an
                      <code>id_token</code>. Token replacement is a OAuth2 Proxy
                      alpha feature, hence it cannot be used in production. The
                      alternative is to configure it to pass
                      <code>access_token</code> via X-Forwarded-Access-Token
                      header, but the <code>id_token</code> in the Authorization
                      header won&#8217;t be replaced. So, first step is to add
                      <code>access_token</code> via X-Forwarded-Access-Token
                      header:
                    </p>
                  </div>
                  <div class="listingblock">
                    <div class="content">
                      <pre
                        class="rouge highlight"
                        style="color: #f8f8f2; background-color: #49483e"
                      ><code>pass_access_token = true</code></pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>
                      Then we need somehow to replace Authorization header on
                      X-Forwarded-Access-Token header. Fortunately, we have
                      Traefik in place. So, let&#8217;s ask Traefik to make a
                      necessary replacement:
                    </p>
                  </div>
                  <div class="listingblock">
                    <div class="content">
                      <pre
                        class="rouge highlight"
                        style="color: #f8f8f2; background-color: #49483e"
                      ><code data-lang="yaml"><span style="color: #a6e22e">http</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
  <span style="color: #a6e22e">middlewares</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
    <span style="color: #a6e22e">che-header-rewrite</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
      <span style="color: #a6e22e">plugin</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
        <span style="color: #a6e22e">header-rewrite</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
          <span style="color: #a6e22e">from</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">X-Forwarded-Access-Token</span>
          <span style="color: #a6e22e">prefix</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">'</span><span style="color: #e6db74">Bearer</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">'</span>
          <span style="color: #a6e22e">to</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">Authorization</span></code></pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>
                      And voila, we made it work, like magic. But how can we
                      make it usable for other users who wants to install
                      Eclipse&#160;Che on AKS? We already mentioned, that at
                      Epam Systems we love complex challenges. And of course we
                      love coding. So, we opened the
                      <a href="https://github.com/eclipse/che/issues/21450"
                        >che-operator enhancements</a
                      >
                      and proposed the
                      <a
                        href="https://github.com/eclipse-che/che-operator/pull/1400"
                        >improvements</a
                      >.
                    </p>
                  </div>
                  <div class="paragraph">
                    <p>
                      As a consequence of the proposed improvements, a new
                      configuration field <code>identityToken</code> has been
                      introduced into Eclipse&#160;Che starting from version
                      7.50. A Eclipse&#160;Che administrator can easily
                      configure what token will be passed to upstream servicees
                      in CheCluster CR (Custom Resource):
                    </p>
                  </div>
                  <div class="listingblock">
                    <div class="content">
                      <pre
                        class="rouge highlight"
                        style="color: #f8f8f2; background-color: #49483e"
                      ><code data-lang="yaml"><span style="color: #a6e22e">spec</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
  <span style="color: #a6e22e">networking</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
    <span style="color: #a6e22e">auth</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
      <span style="color: #a6e22e">identityToken</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">access_token</span></code></pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>
                      There are two types of token supported:
                      <code>id_token</code> and <code>access_token</code>.
                      Default value is <code>id_token</code>.
                    </p>
                  </div>
                  <div class="admonitionblock note">
                    <table>
                      <tr>
                        <td class="icon">
                          <div class="title">Note</div>
                        </td>
                        <td class="content">
                          The field <code>identityToken</code> is specific to
                          Eclipse&#160;Che installations made for Kubernetes
                          only and ignored for OpenShift.
                        </td>
                      </tr>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            <div class="sect1">
              <h2
                id="_challenge-2-no-way-to-obtain-a-proper-access-token-accepted-by-aks"
              >
                Challenge 2: No way to obtain a proper access token accepted by
                AKS
              </h2>
              <div class="sectionbody">
                <div class="paragraph">
                  <p>
                    This is a follow up of Challenge 1: after configuring
                    Eclipse&#160;Che to pass an
                    <code>access_token</code> instead of an
                    <code>id_token</code> we need to make sure that AKS
                    considers it valid.
                  </p>
                </div>
                <div class="paragraph">
                  <p>
                    When AKS integration with AAD is enabled, AKS expects OpenID
                    Connect (OIDC) tokens to be issued from an application,
                    pre-registered in AAD: 'Azure Kubernetes Service AAD
                    Server'.
                  </p>
                </div>
                <div class="imageblock">
                  <div class="content">
                    <img
                      src="/assets/img/installing-eclipse-che-on-aks/aks-aad-server-app.png"
                      alt="Azure Kubernetes Service AAD Server"
                    />
                  </div>
                  <div class="title">
                    Figure 2. Azure Kubernetes Service AAD Server application
                  </div>
                </div>
                <div class="paragraph">
                  <p>
                    Eclipse&#160;Che Gateway OAuth2 Proxy with the default
                    settings uses a standard set of OIDC scopes and AAD will
                    return an <code>access_token</code> that can be used against
                    Microsoft Graph but not against AKS.
                  </p>
                </div>
                <div class="paragraph">
                  <p>
                    In order to return a token that will be accepted by AKS,
                    OAuth2 Proxy should be configured with an additional OIDC
                    scope, representing Azure Kubernetes Service AAD Server
                    application:
                  </p>
                </div>
                <div class="listingblock">
                  <div class="content">
                    <pre
                      class="rouge highlight"
                      style="color: #f8f8f2; background-color: #49483e"
                    ><code data-lang="yaml"><span style="color: #e6db74">6dae42f8-4368-4678-94ff-3960e28e3630/user.read</span></code></pre>
                  </div>
                </div>
                <div class="paragraph">
                  <p>
                    where the ID is the Application ID of the AKS instance
                    registered in AAD.
                  </p>
                </div>
                <div class="sect2">
                  <h3 id="_how-did-we-solve-the-second-challenge">
                    How did we solve the second challenge
                  </h3>
                  <div class="paragraph">
                    <p>
                      A new configuration field named
                      <code>oAuthScope</code> has been introduced into
                      Eclipse&#160;Che starting from version 7.50. That has been
                      specified by the already opened
                      <a href="https://github.com/eclipse/che/issues/21450"
                        >che-operator enhancements</a
                      >
                      and implemented through the provided
                      <a
                        href="https://github.com/eclipse-che/che-operator/pull/1400"
                        >improvement</a
                      >. An Eclipse&#160;Che administrator can easily configure
                      authorization scopes in CheCluster CR:
                    </p>
                  </div>
                  <div class="listingblock">
                    <div class="content">
                      <pre
                        class="rouge highlight"
                        style="color: #f8f8f2; background-color: #49483e"
                      ><code data-lang="yaml"><span style="color: #a6e22e">spec</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
  <span style="color: #a6e22e">networking</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
    <span style="color: #a6e22e">auth</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
      <span style="color: #a6e22e">oAuthScope</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">openid email profile 6dae42f8-4368-4678-94ff-3960e28e3630/user.read</span></code></pre>
                    </div>
                  </div>
                  <div class="admonitionblock note">
                    <table>
                      <tr>
                        <td class="icon">
                          <div class="title">Note</div>
                        </td>
                        <td class="content">
                          The field <code>oAuthScope</code> is specific to
                          Eclipse&#160;Che installations made for Kubernetes
                          only and ignored for OpenShift.
                        </td>
                      </tr>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            <div class="sect1">
              <h2
                id="_challenge-3-che-server-requires-mandatory-email-claim-which-is-absent-in-aks-access_token"
              >
                Challenge 3: Che server requires mandatory 'email' claim which
                is absent in AKS access_token
              </h2>
              <div class="sectionbody">
                <div class="paragraph">
                  <p>
                    Besides passing OIDC token to AKS for authorization
                    purposes, Che server also uses it for creating a 'user'
                    record in PostgreSQL database. There are two pieces of
                    information (claims) about current user that Che server
                    expects to extract from the token: name and email. Che
                    allows configuring of user name claim via CheCluster CR in
                    AKS (<code>CHE_OIDC_USERNAME__CLAIM</code> according to
                    <a
                      href="https://www.eclipse.org/che/docs/next/administration-guide/advanced-configuration-options-for-the-che-server-component/#_che_oidc_username_claim"
                      >documentation</a
                    >), but email claim name is hardcoded to
                    <code>email</code> and cannot be changed. This hardcode
                    becomes a problem for AKS setup since
                    <code>access_token</code> returned by AAD for AKS does not
                    contain <code>email</code> claim (see current structure
                    below), and customization is not possible here since AKS
                    application registration in AAD is maintained by Microsoft.
                  </p>
                </div>
                <div class="listingblock">
                  <div class="content">
                    <pre
                      class="rouge highlight"
                      style="color: #f8f8f2; background-color: #49483e"
                    ><code data-lang="jwt">{
  "typ": "JWT",
  "alg": "RS256",
  "x5t": "2ZQpJ3UpbjAYXYGaXEJl8lV0TOI",
  "kid": "2ZQpJ3UpbjAYXYGaXEJl8lV0TOI"
}.{
  "aud": "6dae42f8-4368-4678-94ff-3960e28e3630",
  "iss": "https://sts.windows.net/f974903a-f693-4ca2-aa63-45e5bd2d1318/",
  "iat": 1656412511,
  "nbf": 1656412511,
  "exp": 1656417802,
  "acr": "1",
  "aio": "AUQAu/8TAABB1o0F/h6L8SJWLibrQqPKrVF7qpdIFiQ0qeIj/wNUfcLkM87v+wgvQ+I8uj0WC2Y6WEoHlBcsJdt0m+kJ4dFeNw==",
  "amr": [
    "pwd"
  ],
  "appid": "1c0b88a0-8ec2-4cca-a2b0-4f468110ef86",
  "appidacr": "1",
  "family_name": "Kluklu",
  "given_name": "Tratata",
  "groups": [
    "73fdccdf-e10d-45f9-b7f6-31848842999f",
    "5988d043-3af9-4e81-b041-90b3456f9f4e",
    "bddcb049-0337-4dec-bbaf-7600b8c12623"
  ],
  "ipaddr": "10.123.51.3",
  "name": "Tratata Kluklu",
  "oid": "2cf0521c-c76d-4e7c-b41f-863674057db3",
  "onprem_sid": "S-2-4-31-6364504-298352422-13854118-387761",
  "puid": "3213CDFA3CAF2IA5",
  "rh": "0.AQkA1NIbtJ39JkuKaqbJ82fCHscCrm1oG3hTlP47YOQHDjAJAHg.",
  "scp": "user.read",
  "sub": "qweBLvHX49QA5WlXpJzq_erXQ2NldnSqpgY93oALLDY",
  "tid": "a385e78a-aedc-4033-82ba-e6ef88120591",
  "unique_name": "Tratata.Kluklu@gmail.com",
  "upn": "Tratata.Kluklu@gmail.com",
  "uti": "lfZmPsgcWmS3dG78GpMjRA",
  "ver": "1.0",
  "wids": [
    "c79abafb-610b-4a34-82e2-ef7a293db6ca"
  ]
}.[Signature]</code></pre>
                  </div>
                </div>
                <div class="sect2">
                  <h3 id="_how-did-we-solve-the-third-challenge">
                    How did we solve the third challenge
                  </h3>
                  <div class="paragraph">
                    <p>
                      As for the previous challenges, we need some enhancements
                      on Eclipse&#160;Che side here too. We want to allow
                      administrators to configure what token claim need to be
                      used to extract user email. As we did it before, we opened
                      the
                      <a href="https://github.com/eclipse/che/issues/21515"
                        >che-server enhancement</a
                      >
                      and proposed the
                      <a
                        href="https://github.com/eclipse-che/che-server/pull/324"
                        >improvement</a
                      >.
                    </p>
                  </div>
                  <div class="paragraph">
                    <p>
                      Now Eclipse&#160;Che adminstrators can configure the email
                      claim to be used when parsing the JWT token:
                    </p>
                  </div>
                  <div class="listingblock">
                    <div class="content">
                      <pre
                        class="rouge highlight"
                        style="color: #f8f8f2; background-color: #49483e"
                      ><code data-lang="yaml"><span style="color: #a6e22e">spec</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
  <span style="color: #a6e22e">components</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
    <span style="color: #a6e22e">cheServer</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
      <span style="color: #a6e22e">extraProperties</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
        <span style="color: #a6e22e">CHE_OIDC_EMAIL__CLAIM</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">unique_name</span></code></pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>
                      If not defined, the fallback value is <code>email</code>.
                    </p>
                  </div>
                </div>
              </div>
            </div>
            <div class="sect1">
              <h2 id="_conclusion">Conclusion</h2>
              <div class="sectionbody">
                <div class="paragraph">
                  <p>
                    In this post, we walked through the challenges we faced to
                    install Eclipse&#160;Che on AKS and how we contributed back
                    to the project to address the issues.
                  </p>
                </div>
                <div class="paragraph">
                  <p>
                    Now, user has all needed things configurable to be able to
                    run successfully Eclipse&#160;Che on AKS. For example, in
                    our particular case we prepared yaml file that overrides the
                    default values in CheCluster CR.
                  </p>
                </div>
                <div class="listingblock">
                  <div class="content">
                    <pre
                      class="rouge highlight"
                      style="color: #f8f8f2; background-color: #49483e"
                    ><code data-lang="yaml"><span style="color: #a6e22e">spec</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
  <span style="color: #a6e22e">networking</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
    <span style="color: #a6e22e">auth</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
      <span style="color: #a6e22e">identityProviderURL</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">https://sts.windows.net/{TENANT_ID}/v2.0/</span>
      <span style="color: #a6e22e">identityToken</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">access_token</span>
      <span style="color: #a6e22e">oAuthClientName</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f8f8f2">CLIENT_ID</span><span style="color: #f8f8f2;background-color: #49483e">}</span>
      <span style="color: #a6e22e">oAuthSecret</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #f8f8f2;background-color: #49483e">{</span><span style="color: #f8f8f2">CLIENT_SECRET</span><span style="color: #f8f8f2;background-color: #49483e">}</span>
      <span style="color: #a6e22e">oAuthScope</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">openid email profile 6dae42f8-4368-4678-94ff-3960e28e3630/user.read</span>
  <span style="color: #a6e22e">components</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
    <span style="color: #a6e22e">cheServer</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
      <span style="color: #a6e22e">extraProperties</span><span style="color: #f8f8f2;background-color: #49483e">:</span>
        <span style="color: #a6e22e">CHE_OIDC_AUTH__SERVER__URL</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">https://sts.windows.net/{TENANT_ID}/v2.0/</span>
        <span style="color: #a6e22e">CHE_OIDC_EMAIL__CLAIM</span><span style="color: #f8f8f2;background-color: #49483e">:</span> <span style="color: #e6db74">unique_name</span></code></pre>
                  </div>
                </div>
                <div class="ulist">
                  <ul>
                    <li>
                      <p>
                        <code>TENANT_ID</code> - Directory (tenant) ID, see
                        Figure 3.
                      </p>
                    </li>
                    <li>
                      <p>
                        <code>CLIENT_ID</code> - Application (client) ID, see
                        Figure 3.
                      </p>
                    </li>
                    <li>
                      <p>
                        <code>CLIENT_SECRET</code> - Client secret, you can
                        manage it in 'Certificates &amp; secret' section
                      </p>
                    </li>
                  </ul>
                </div>
                <div class="imageblock">
                  <div class="content">
                    <img
                      src="/assets/img/installing-eclipse-che-on-aks/azure-che-demo-app.png"
                      alt="Registered Che application"
                    />
                  </div>
                  <div class="title">Figure 3. Registered Che application</div>
                </div>
                <div class="admonitionblock warning">
                  <table>
                    <tr>
                      <td class="icon">
                        <div class="title">Warning</div>
                      </td>
                      <td class="content">
                        Don&#8217;t forget to configure API permissions to
                        authorize your application to call AKS Server API.
                      </td>
                    </tr>
                  </table>
                </div>
                <div class="imageblock">
                  <div class="content">
                    <img
                      src="/assets/img/installing-eclipse-che-on-aks/aks-api-permissions.png"
                      alt="AKS API permissions"
                    />
                  </div>
                  <div class="title">Figure 4. AKS API permissions</div>
                </div>
                <div class="paragraph">
                  <p>
                    After the Eclipse&#160;Che App configuration in Azure is
                    completed, the command <code>chectl server:deploy</code> can
                    be used to install Eclipse&#160;Che on AKS using the
                    <code>YAML</code> file above:
                  </p>
                </div>
                <div class="listingblock">
                  <div class="content">
                    <pre
                      class="rouge highlight"
                      style="color: #f8f8f2; background-color: #49483e"
                    ><code data-lang="shell">chectl server:deploy <span style="color: #ae81ff">\</span>
       <span style="color: #f92672">--platform</span><span style="color: #f92672;font-weight: bold">=</span>k8s <span style="color: #ae81ff">\</span>
       <span style="color: #f92672">--installer</span><span style="color: #f92672;font-weight: bold">=</span>operator <span style="color: #ae81ff">\</span>
       <span style="color: #f92672">--che-operator-cr-patch-yaml</span><span style="color: #f92672;font-weight: bold">=</span>che.yaml <span style="color: #ae81ff">\</span>
       <span style="color: #f92672">--skip-oidc-provider-check</span> <span style="color: #ae81ff">\</span>
       <span style="color: #f92672">--skip-cert-manager</span> <span style="color: #ae81ff">\</span>
       <span style="color: #f92672">--domain</span><span style="color: #f92672;font-weight: bold">=</span>eclipse-che-demo.mydomain.com</code></pre>
                  </div>
                </div>
                <div class="admonitionblock note">
                  <table>
                    <tr>
                      <td class="icon">
                        <div class="title">Note</div>
                      </td>
                      <td class="content">
                        In our case we already configured
                        <code>cert-manager</code> and created
                        <code>domain</code> according to the
                        <a
                          href="https://www.eclipse.org/che/docs/che-7/installation-guide/installing-che-on-microsoft-azure/"
                          >old (7.41) instructions</a
                        >.
                      </td>
                    </tr>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <a
            class="u-url"
            href="/2022/07/25/@karatkep-installing-eclipse-che-on-aks.html"
            hidden
          ></a>
        </article>
      </div>
    </main>
    <footer class="site-footer h-card">
      <data class="u-url" href="/"></data>

      <div class="wrapper">
        <h2 class="footer-heading">Eclipse Che Blog</h2>

        <div class="footer-col-wrapper">
          <div class="footer-col footer-col-1">
            <ul class="contact-list">
              <li class="p-name">Eclipse Che Blog</li>
              <li>
                <a class="u-email" href="mailto:che-dev@eclipse.org"
                  >che-dev@eclipse.org</a
                >
              </li>
            </ul>
          </div>

          <div class="footer-col footer-col-2">
            <ul class="social-media-list">
              <li>
                <a href="https://github.com/eclipse-che"
                  ><svg class="svg-icon">
                    <use
                      xlink:href="/assets/minima-social-icons.svg#github"
                    ></use>
                  </svg>
                  <span class="username">eclipse-che</span></a
                >
              </li>
              <li>
                <a href="https://www.twitter.com/eclipse_che"
                  ><svg class="svg-icon">
                    <use
                      xlink:href="/assets/minima-social-icons.svg#twitter"
                    ></use>
                  </svg>
                  <span class="username">eclipse_che</span></a
                >
              </li>
            </ul>
          </div>

          <div class="footer-col footer-col-3">
            <p>Eclipse Che runs IDEs in Kubernetes.</p>
          </div>
        </div>
      </div>
    </footer>
  </body>
</html>
