<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Begin Jekyll SEO tag v2.8.0 -->
    <title>
      Drive a coupe with the overlay storage driver - a Podman build comparison
      | Eclipse Che Blog
    </title>
    <meta name="generator" content="Jekyll v4.2.2" />
    <meta
      property="og:title"
      content="Drive a coupe with the overlay storage driver - a Podman build comparison"
    />
    <meta name="author" content="David Kwon" />
    <meta property="og:locale" content="en_US" />
    <meta
      name="description"
      content="Enable faster builds and storage optimization with the fuse-overlayfs storage driver in Eclipse Che."
    />
    <meta
      property="og:description"
      content="Enable faster builds and storage optimization with the fuse-overlayfs storage driver in Eclipse Che."
    />
    <link
      rel="canonical"
      href="https://che.eclipseprojects.io/2024/03/28/@david.kwon-fuse-storage-driver.html"
    />
    <meta
      property="og:url"
      content="https://che.eclipseprojects.io/2024/03/28/@david.kwon-fuse-storage-driver.html"
    />
    <meta property="og:site_name" content="Eclipse Che Blog" />
    <meta property="og:type" content="article" />
    <meta
      property="article:published_time"
      content="2024-03-28T00:00:00+00:00"
    />
    <meta name="twitter:card" content="summary" />
    <meta
      property="twitter:title"
      content="Drive a coupe with the overlay storage driver - a Podman build comparison"
    />
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "author": { "@type": "Person", "name": "David Kwon" },
        "dateModified": "2024-03-28T00:00:00+00:00",
        "datePublished": "2024-03-28T00:00:00+00:00",
        "description": "Enable faster builds and storage optimization with the fuse-overlayfs storage driver in Eclipse Che.",
        "headline": "Drive a coupe with the overlay storage driver - a Podman build comparison",
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": "https://che.eclipseprojects.io/2024/03/28/@david.kwon-fuse-storage-driver.html"
        },
        "url": "https://che.eclipseprojects.io/2024/03/28/@david.kwon-fuse-storage-driver.html"
      }
    </script>
    <!-- End Jekyll SEO tag -->
    <link rel="stylesheet" href="/assets/main.css" />
    <link
      type="application/atom+xml"
      rel="alternate"
      href="https://che.eclipseprojects.io/feed.xml"
      title="Eclipse Che Blog"
    />
    <script>
      if (
        !(
          window.doNotTrack === "1" ||
          navigator.doNotTrack === "1" ||
          navigator.doNotTrack === "yes" ||
          navigator.msDoNotTrack === "1"
        )
      ) {
        (function (i, s, o, g, r, a, m) {
          i["GoogleAnalyticsObject"] = r;
          (i[r] =
            i[r] ||
            function () {
              (i[r].q = i[r].q || []).push(arguments);
            }),
            (i[r].l = 1 * new Date());
          (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
          a.async = 1;
          a.src = g;
          m.parentNode.insertBefore(a, m);
        })(
          window,
          document,
          "script",
          "https://www.google-analytics.com/analytics.js",
          "ga"
        );

        ga("create", "UA-215676970-1", "auto");
        ga("send", "pageview");
      }
    </script>
  </head>
  <body>
    <header class="site-header" role="banner">
      <div class="wrapper">
        <a class="site-title" rel="author" href="/">Eclipse Che Blog</a>
        <nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger" />
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewBox="0 0 18 15" width="18px" height="15px">
                <path
                  d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"
                />
              </svg>
            </span>
          </label>

          <div class="trigger"></div>
        </nav>
      </div>
    </header>
    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article
          class="post h-entry"
          itemscope
          itemtype="http://schema.org/BlogPosting"
        >
          <header class="post-header">
            <h1 class="post-title p-name" itemprop="name headline">
              Drive a coupe with the overlay storage driver - a Podman build
              comparison
            </h1>
            <p class="post-meta">
              <time
                class="dt-published"
                datetime="2024-03-28T00:00:00+00:00"
                itemprop="datePublished"
                >Mar 28, 2024 </time
              >•
              <span
                itemprop="author"
                itemscope
                itemtype="http://schema.org/Person"
                ><span class="p-author h-card" itemprop="name"
                  >David Kwon</span
                ></span
              >
            </p>
          </header>

          <div class="post-content e-content" itemprop="articleBody">
            <div class="paragraph">
              <p>
                With the fuse-overlayfs storage driver, you can enable faster
                builds and a more optimized storage usage for
                <code>podman build</code> and <code>buildah</code> within your
                Eclipse Che cloud development environment (CDE). Before diving
                into its advantages, let&#8217;s first discuss some prerequisite
                details about container image layers and storage drivers.
              </p>
            </div>
            <div class="paragraph">
              <p>
                Container images consist of
                <a href="https://docs.docker.com/build/guide/layers">layers</a>
                which are stored and used for building and running containers. A
                huge benefit of this layer anatomy is that, assuming that each
                image layer stores only the file differences compared to the
                previous layer (i.e. the delta), each layer is small which
                generally allows time and space savings when building and
                running containers. This is because layers allow efficient
                caching and sharing between containers.
              </p>
            </div>
            <div class="paragraph">
              <p>
                A
                <a
                  href="https://docs.docker.com/storage/storagedriver/select-storage-driver"
                  >storage driver</a
                >
                for Docker and Podman is what manages these image layers upon
                image pulling, building, and running. By default, Eclipse Che
                uses the vfs storage driver for Podman in the
                <a href="https://github.com/devfile/developer-images"
                  >Universal Development Image</a
                >. While vfs is generally considered very stable, the lack of
                <a href="https://en.wikipedia.org/wiki/Copy-on-write"
                  >copy-on-write</a
                >
                (CoW) support poses a significant disadvantage compared to other
                storage drivers like fuse-overlayfs, overlay2, and btrfs.
              </p>
            </div>
            <div class="sect1">
              <h2 id="_what-is-the-disadvantage-of-vfs">
                What is the disadvantage of vfs?
              </h2>
              <div class="sectionbody">
                <div class="paragraph">
                  <p>
                    As mentioned previously, having smaller layers allows time
                    and space savings when building and running containers. The
                    disadvantage with vfs&#8217;s lack of CoW is that whenever a
                    new layer is created, a complete copy of the previous layer
                    is created. This can create duplicate and redundant data in
                    each layer, and can quickly fill up your storage space
                    especially when working with larger images. Comparing that
                    with image layers created with CoW-supported storage drivers
                    like fuse-overlayfs, those image layers would typically not
                    contain redundant data and would remain smaller since only
                    the delta is stored in each image layer.
                  </p>
                </div>
                <div class="imageblock">
                  <div class="content">
                    <img
                      src="/assets/img/fuse-storage-driver/layer-diagram.png"
                      alt="layer diagram"
                    />
                  </div>
                </div>
                <div class="paragraph">
                  <p>
                    Fig. 1. Example comparison of image layer sizes between vfs
                    and overlay storage drivers. The total size of the image
                    layers created with overlay is about half the size of the
                    image layers created with vfs.
                  </p>
                </div>
              </div>
            </div>
            <div class="sect1">
              <h2
                id="_how-can-we-use-fuse-overlayfs-in-an-eclipse-che-cloud-development-environment"
              >
                How can we use fuse-overlayfs in an Eclipse Che cloud
                development environment?
              </h2>
              <div class="sectionbody">
                <div class="paragraph">
                  <p>
                    To use fuse-overlayfs in a CDE, the CDE&#8217;s pod requires
                    access to the <code>/dev/fuse</code> device from the host
                    operating system. For Kubernetes, support for this can vary
                    depending on the platform. However, for Openshift, version
                    4.15 allows access to the <code>/dev/fuse</code> device
                    <a
                      href="https://docs.openshift.com/container-platform/4.15/release_notes/ocp-4-15-release-notes.html#ocp-4-15-nodes-dev-fuse"
                      >without any cluster modifications</a
                    >. Here&#8217;s the documentation on how to
                    <a
                      href="https://eclipse.dev/che/docs/stable/end-user-guide/accessing-fuse"
                      >enable the overlay storage driver for CDEs running on
                      OpenShift 4.15 and older versions</a
                    >.
                  </p>
                </div>
              </div>
            </div>
            <div class="sect1">
              <h2
                id="_how-does-fuse-overlayfs-compare-to-vfs-in-an-eclipse-che-cde"
              >
                How does fuse-overlayfs compare to vfs in an Eclipse Che CDE?
              </h2>
              <div class="sectionbody">
                <div class="paragraph">
                  <p>
                    A series of tests were performed to measure the build time
                    and storage usage differences between the fuse-overlayfs and
                    vfs storage drivers in an Eclipse Che CDE. For this blog
                    post, I will present the measurements for building a series
                    of different GitHub projects. If you&#8217;re interested,
                    the results for tests that were specifically designed to
                    highlight the characteristics of each storage driver are
                    available in this
                    <a
                      href="https://github.com/dkwon17/storage-driver-test/blob/main/results.md"
                      >GitHub repository</a
                    >.
                  </p>
                </div>
                <div class="paragraph">
                  <p>
                    All tests presented in Fig. 2. were run on an OpenShift
                    Dedicated 4.15.3 cluster with a productized version of
                    Eclipse Che 7.82.0.
                  </p>
                </div>
                <table class="tableblock frame-all grid-all stretch">
                  <colgroup>
                    <col style="width: 50%" />
                    <col style="width: 50%" />
                  </colgroup>
                  <thead>
                    <tr>
                      <th class="tableblock halign-left valign-top">
                        Test name
                      </th>
                      <th class="tableblock halign-left valign-top">
                        Project URL
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td class="tableblock halign-left valign-top">
                        <p class="tableblock">dashboard</p>
                      </td>
                      <td class="tableblock halign-left valign-top">
                        <p class="tableblock">
                          <a href="https://github.com/eclipse-che/che-dashboard"
                            >che-dashboard</a
                          >
                        </p>
                      </td>
                    </tr>
                    <tr>
                      <td class="tableblock halign-left valign-top">
                        <p class="tableblock">dashboard-edit</p>
                      </td>
                      <td class="tableblock halign-left valign-top">
                        <p class="tableblock">
                          <a href="https://github.com/eclipse-che/che-dashboard"
                            >che-dashboard</a
                          >
                        </p>
                      </td>
                    </tr>
                    <tr>
                      <td class="tableblock halign-left valign-top">
                        <p class="tableblock">operator</p>
                      </td>
                      <td class="tableblock halign-left valign-top">
                        <p class="tableblock">
                          <a href="https://github.com/eclipse-che/che-operator"
                            >che-operator</a
                          >
                        </p>
                      </td>
                    </tr>
                    <tr>
                      <td class="tableblock halign-left valign-top">
                        <p class="tableblock">operator-edit</p>
                      </td>
                      <td class="tableblock halign-left valign-top">
                        <p class="tableblock">
                          <a href="https://github.com/eclipse-che/che-operator"
                            >che-operator</a
                          >
                        </p>
                      </td>
                    </tr>
                    <tr>
                      <td class="tableblock halign-left valign-top">
                        <p class="tableblock">server</p>
                      </td>
                      <td class="tableblock halign-left valign-top">
                        <p class="tableblock">
                          <a href="https://github.com/eclipse-che/che-server"
                            >che-server</a
                          >
                        </p>
                      </td>
                    </tr>
                    <tr>
                      <td class="tableblock halign-left valign-top">
                        <p class="tableblock">server-edit</p>
                      </td>
                      <td class="tableblock halign-left valign-top">
                        <p class="tableblock">
                          <a href="https://github.com/eclipse-che/che-server"
                            >che-server</a
                          >
                        </p>
                      </td>
                    </tr>
                    <tr>
                      <td class="tableblock halign-left valign-top">
                        <p class="tableblock">nginx-alpine</p>
                      </td>
                      <td class="tableblock halign-left valign-top">
                        <p class="tableblock">
                          <a
                            href="https://github.com/nginxinc/docker-nginx/tree/master/stable/alpine"
                            >docker-nginx</a
                          >
                        </p>
                      </td>
                    </tr>
                    <tr>
                      <td class="tableblock halign-left valign-top">
                        <p class="tableblock">quarkus-api-example</p>
                      </td>
                      <td class="tableblock halign-left valign-top">
                        <p class="tableblock">
                          <a
                            href="https://github.com/che-incubator/quarkus-api-example"
                            >quarkus-api-example</a
                          >
                        </p>
                      </td>
                    </tr>
                  </tbody>
                </table>
                <div class="paragraph">
                  <p>Fig. 2. Table of test names name project URLs.</p>
                </div>
                <div class="paragraph">
                  <p>
                    For each test apart from the &lt;projectname&gt;-edit tests,
                    the <code>podman system reset</code> command was run before
                    running each test in order to clear the graphroot directory.
                    This removes all image layers, therefore these tests measure
                    a clean-build scenario, just like when a user creates a CDE
                    and runs <code>podman build</code> for the first time.
                  </p>
                </div>
                <div class="paragraph">
                  <p>
                    For the &lt;projectname&gt;-edit tests, the image container
                    was built beforehand. The tests measure a rebuild of the
                    image after changing the source code without running
                    <code>podman system reset</code> command. This scenario
                    mimics the case where the developer is running a new build
                    after making code changes in their CDE.
                  </p>
                </div>
                <div class="imageblock">
                  <div class="content">
                    <img
                      src="/assets/img/fuse-storage-driver/image-build-time.png"
                      alt="image build time"
                    />
                  </div>
                </div>
                <div class="paragraph">
                  <p>Fig. 3. Container image build time results</p>
                </div>
                <div class="imageblock">
                  <div class="content">
                    <img
                      src="/assets/img/fuse-storage-driver/graphroot-size.png"
                      alt="graphroot size"
                    />
                  </div>
                </div>
                <div class="paragraph">
                  <p>Fig. 4. Graphroot directory size results</p>
                </div>
                <div class="paragraph">
                  <p>
                    For all tests, the fuse-overlayfs storage driver had faster
                    build times and significantly smaller storage consumption
                    compared to vfs. The benefits of CoW is especially evident
                    in Fig. 4. For example the operator-edit test showed that by
                    using fuse-overlayfs, the graphroot directory was about 88%
                    smaller, saving about 15GB of storage.
                  </p>
                </div>
              </div>
            </div>
            <div class="sect1">
              <h2 id="_conclusion">Conclusion</h2>
              <div class="sectionbody">
                <div class="paragraph">
                  <p>
                    In conclusion, the fuse-overlayfs storage driver should be
                    considered for your Eclipse Che CDEs, saving time and
                    storage thanks to the CoW support. In general, there is no
                    “best” storage driver because performance, stability, and
                    usability of each storage driver is dependent on your
                    specific workload and environment. However, with vfs not
                    supporting CoW, fuse-overlayfs is a much more suitable
                    choice for image layer management.
                  </p>
                </div>
                <div class="paragraph">
                  <p>
                    For additional content regarding fuse-overlayfs in Eclipse
                    Che, check out this
                    <a
                      href="https://upstreamwithoutapaddle.com/blog%20post/2023/08/10/Podman-In-Dev-Spaces-With-Fuse-Overlay.html"
                      >blog post and demo project</a
                    >.
                  </p>
                </div>
                <div class="paragraph">
                  <p>Thank you for reading.</p>
                </div>
              </div>
            </div>
          </div>
          <a
            class="u-url"
            href="/2024/03/28/@david.kwon-fuse-storage-driver.html"
            hidden
          ></a>
        </article>
      </div>
    </main>
    <footer class="site-footer h-card">
      <data class="u-url" href="/"></data>

      <div class="wrapper">
        <h2 class="footer-heading">Eclipse Che Blog</h2>

        <div class="footer-col-wrapper">
          <div class="footer-col footer-col-1">
            <ul class="contact-list">
              <li class="p-name">Eclipse Che Blog</li>
              <li>
                <a class="u-email" href="mailto:che-dev@eclipse.org"
                  >che-dev@eclipse.org</a
                >
              </li>
            </ul>
          </div>

          <div class="footer-col footer-col-2">
            <ul class="social-media-list">
              <li>
                <a href="https://github.com/eclipse-che"
                  ><svg class="svg-icon">
                    <use
                      xlink:href="/assets/minima-social-icons.svg#github"
                    ></use>
                  </svg>
                  <span class="username">eclipse-che</span></a
                >
              </li>
              <li>
                <a href="https://www.twitter.com/eclipse_che"
                  ><svg class="svg-icon">
                    <use
                      xlink:href="/assets/minima-social-icons.svg#twitter"
                    ></use>
                  </svg>
                  <span class="username">eclipse_che</span></a
                >
              </li>
            </ul>
          </div>

          <div class="footer-col footer-col-3">
            <p>Eclipse Che runs IDEs in Kubernetes.</p>
          </div>
        </div>
      </div>
    </footer>
  </body>
</html>
